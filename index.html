<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Verse - Aventures Infinies par IA</title>
    <!-- Importation des polices Google Fonts pour un style coh√©rent -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styles CSS globaux et variables */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Couleurs principales */
            --primary-bg: #0a0a0a; /* Fond tr√®s sombre */
            --secondary-bg: #1a1a1a; /* Fond des conteneurs */
            --card-bg: rgba(30, 30, 30, 0.9); /* Fond des cartes avec transparence */
            --accent-color: #00d9ff; /* Couleur d'accentuation principale (bleu cyan) */
            --accent-secondary: #ff6b35; /* Couleur d'accentuation secondaire (orange) */
            --success-color: #00ff88; /* Couleur pour le succ√®s (vert vif) */
            --warning-color: #ffaa00; /* Couleur pour les avertissements (orange) */
            --error-color: #ff4444; /* Couleur pour les erreurs (rouge) */
            --text-primary: #ffffff; /* Couleur du texte principal (blanc) */
            --text-secondary: #b0b0b0; /* Couleur du texte secondaire (gris clair) */
            --border-color: rgba(0, 217, 255, 0.3); /* Couleur des bordures avec transparence */

            /* Couleurs sp√©cifiques aux stats */
            --health-color: #ff4444; /* Rouge pour la sant√© */
            --energy-color: #4488ff; /* Bleu pour l'√©nergie */
            --gold-color: #ffdd44; /* Jaune pour l'or */

            /* Polices */
            --font-orbitron: 'Orbitron', sans-serif;
            --font-rajdhani: 'Rajdhani', sans-serif;
        }

        body {
            /* Fond d√©grad√© du corps */
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: var(--text-primary);
            font-family: var(--font-rajdhani);
            overflow-x: hidden; /* Emp√™che le d√©filement horizontal */
            min-height: 100vh; /* Hauteur minimale pour que le fond couvre tout l'√©cran */
            position: relative;
        }

        /* Fond anim√© (bulles lumineuses) */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* En arri√®re-plan */
            background:
                radial-gradient(circle at 20% 80%, rgba(0, 217, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 107, 53, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 255, 136, 0.08) 0%, transparent 50%);
            animation: bgPulse 15s ease-in-out infinite alternate; /* Animation de pulsation */
        }

        /* Animation des √©toiles */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Au-dessus de animated-bg */
            background-image:
                radial-gradient(2px 2px at 20px 30px, #eee, transparent), /* Petites √©toiles */
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent), /* √âtoiles moyennes */
                radial-gradient(1px 1px at 90px 40px, #fff, transparent); /* Grosses √©toiles */
            background-repeat: repeat;
            background-size: 200px 100px; /* Taille pour r√©p√©ter les √©toiles */
            animation: twinkle 20s linear infinite; /* Animation de scintillement */
        }

        /* Keyframes pour les animations de fond */
        @keyframes bgPulse {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes twinkle {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-100px); } /* D√©filement lent des √©toiles */
        }

        /* Header (en-t√™te fixe) */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.95); /* Fond semi-transparent */
            backdrop-filter: blur(15px); /* Effet de flou derri√®re le header */
            border-bottom: 1px solid var(--border-color);
            z-index: 1000; /* Assure qu'il est au-dessus du contenu */
            padding: 1rem 2rem;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-family: var(--font-orbitron);
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
            -webkit-background-clip: text; /* Pour les navigateurs Webkit */
            -webkit-text-fill-color: transparent; /* Pour les navigateurs Webkit */
            background-clip: text; /* Pour les navigateurs modernes */
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.5); /* Ombre lumineuse */
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .save-status {
            padding: 0.5rem 1rem;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--success-color);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--success-color);
            transition: all 0.3s ease;
        }

        .save-status.warning {
            background: rgba(255, 170, 0, 0.2);
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        /* Container principal du contenu */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 6rem 2rem 2rem; /* Espace pour le header */
            min-height: 100vh;
        }

        /* √âcrans de jeu */
        .screen {
            display: none; /* Cach√© par d√©faut */
            animation: fadeIn 0.6s ease-in-out; /* Animation d'apparition */
        }

        .screen.active {
            display: block; /* Affich√© quand actif */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* √âcran d'accueil */
        .home-section {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .welcome-title {
            font-family: var(--font-orbitron);
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(0, 217, 255, 0.3);
            animation: glow 3s ease-in-out infinite alternate; /* Animation de lueur */
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 10px rgba(0, 217, 255, 0.5)); }
            to { filter: drop-shadow(0 0 20px rgba(0, 217, 255, 0.8)); }
        }

        .welcome-subtitle {
            font-size: 1.3rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        /* Texte d'introduction pour les nouveaux joueurs */
        .introduction-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            line-height: 1.7;
            margin-bottom: 3rem;
            padding: 2rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            position: relative;
            text-align: left; /* Texte align√© √† gauche */
        }

        .introduction-text::before {
            content: "‚ú®"; /* Ic√¥ne d√©corative */
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-bg);
            padding: 0 1rem;
            font-size: 1.5rem;
        }

        /* Styles des cartes (panneaux d'information) */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(15px);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            text-align: left;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 217, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .card:hover::before {
            left: 100%; /* Effet de balayage au survol */
        }

        .card:hover {
            border-color: var(--accent-color);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.3);
            transform: translateY(-2px); /* L√©ger mouvement vers le haut */
        }

        /* Styles des formulaires */
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
            position: relative;
        }

        .form-label {
            display: block;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1.2rem;
            background: rgba(26, 26, 26, 0.9);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: var(--font-rajdhani);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
            background: rgba(26, 26, 26, 1);
        }

        .form-textarea {
            resize: vertical; /* Permet de redimensionner verticalement */
            min-height: 100px;
        }

        .form-select {
            appearance: none; /* Supprime le style par d√©faut du select */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300D9FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); /* Fl√®che personnalis√©e */
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            padding-right: 2.5rem; /* Espace pour la fl√®che */
        }

        /* Styles des boutons */
        .btn {
            display: inline-block;
            padding: 1rem 2.5rem;
            background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%; /* Effet de brillance au survol */
        }

        .btn:hover {
            transform: translateY(-3px); /* L√©ger mouvement vers le haut */
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.5); /* Ombre plus prononc√©e */
        }

        .btn:active {
            transform: translateY(-1px); /* Effet de pression */
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--accent-color);
        }

        /* Layout du jeu principal */
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 320px; /* Colonne principale pour l'histoire, colonne lat√©rale pour les stats */
            gap: 2rem;
            height: calc(100vh - 8rem); /* Hauteur calcul√©e pour s'adapter √† l'√©cran moins le header */
        }

        .story-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .story-content {
            flex: 1; /* Prend l'espace disponible */
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 2rem;
            overflow-y: auto; /* D√©filement vertical pour l'histoire */
            backdrop-filter: blur(15px);
            position: relative;
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-primary);
        }

        .story-entry {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideIn 0.5s ease-out; /* Animation d'apparition de chaque entr√©e */
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .story-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .story-text {
            margin-bottom: 1rem;
        }

        .action-text {
            color: var(--accent-color);
            font-style: italic;
            font-size: 0.95rem;
            background: rgba(0, 217, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
            display: block; /* S'assure que le bloc prend toute la largeur */
            margin-top: 1rem;
        }

        /* Panneau d'action (input + bouton) */
        .action-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .quick-action-btn {
            padding: 0.8rem;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center; /* Centrer le contenu */
            gap: 0.5rem;
            text-align: center;
        }

        .quick-action-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .action-input {
            width: 100%;
            padding: 1rem;
            background: rgba(26, 26, 26, 0.9);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            resize: vertical;
            min-height: 120px;
            margin-bottom: 1rem;
            font-family: var(--font-rajdhani);
            transition: all 0.3s ease;
        }

        .action-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        /* Panneau lat√©ral (stats et inventaire) */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .stats-panel, .inventory-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(15px);
        }

        .panel-title {
            font-family: var(--font-orbitron);
            font-size: 1.2rem;
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        /* Barres de progression des stats */
        .stat-item {
            margin-bottom: 1rem;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .stat-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .stat-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
        }

        .stat-fill.health {
            background: linear-gradient(90deg, var(--health-color), #ff8888);
        }

        .stat-fill.energy {
            background: linear-gradient(90deg, var(--energy-color), #88aaff);
        }

        .stat-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite; /* Effet de brillance sur la barre */
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .gold-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: rgba(255, 221, 68, 0.1);
            border: 1px solid var(--gold-color);
            border-radius: 8px;
            padding: 0.8rem;
            margin-top: 1rem;
            color: var(--gold-color);
        }

        /* Inventaire */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 colonnes pour les emplacements */
            gap: 0.5rem;
        }

        .inventory-slot {
            aspect-ratio: 1; /* Force les slots √† √™tre carr√©s */
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* Taille de l'ic√¥ne ou du texte */
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            color: var(--text-secondary); /* Couleur par d√©faut pour les slots vides */
        }

        .inventory-slot:hover {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--accent-color);
        }

        .inventory-slot.filled {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--accent-color);
            color: var(--text-primary); /* Couleur pour les slots remplis */
        }

        .inventory-slot span {
            font-size: 1.2rem; /* Taille du texte de l'objet */
            text-align: center;
            padding: 5px;
            word-break: break-word; /* G√®re les longs noms */
        }


        /* Styles des cartes de s√©lection de mode (arch√©type) */
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
            gap: 2rem;
            margin-top: 2rem;
        }

        .mode-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 217, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .mode-card:hover::before,
        .mode-card.selected::before {
            left: 100%;
        }

        .mode-card:hover,
        .mode-card.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 25px rgba(0, 217, 255, 0.3);
            transform: translateY(-5px);
        }

        .mode-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }

        .mode-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-family: var(--font-orbitron);
        }

        .mode-description {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Indicateur de chargement */
        .loading {
            display: none; /* Cach√© par d√©faut */
            text-align: center;
            padding: 2rem;
            color: var(--accent-color);
            font-size: 1.2rem;
        }

        .spinner {
            border: 4px solid rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--accent-color);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications (petits messages en haut √† droite) */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--success-color);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            color: var(--success-color);
            font-weight: 600;
            z-index: 10001;
            backdrop-filter: blur(10px);
            animation: slideInRight 0.5s ease-out; /* Animation d'apparition */
            max-width: 300px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .notification.error {
            border-color: var(--error-color);
            color: var(--error-color);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }

        .notification.warning {
            border-color: var(--warning-color);
            color: var(--warning-color);
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Alertes (modales au centre de l'√©cran) */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .alert-content {
            background: var(--card-bg);
            border: 2px solid var(--error-color);
            border-radius: 15px;
            padding: 2rem;
            z-index: 10000;
            backdrop-filter: blur(15px);
            box-shadow: 0 0 40px rgba(255, 68, 68, 0.4);
            max-width: 450px;
            width: 90%;
            animation: popIn 0.3s ease-out;
            text-align: center;
        }

        .alert-content.success { border-color: var(--success-color); box-shadow: 0 0 40px rgba(0, 255, 136, 0.4); }
        .alert-content.warning { border-color: var(--warning-color); box-shadow: 0 0 40px rgba(255, 170, 0, 0.4); }


        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .alert-title {
            color: var(--error-color);
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            font-family: var(--font-orbitron);
        }

        .alert-content.success .alert-title { color: var(--success-color); }
        .alert-content.warning .alert-title { color: var(--warning-color); }

        .alert-message {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }

        /* Responsive design pour les petits √©crans */
        @media (max-width: 768px) {
            .container {
                padding: 6rem 1rem 2rem;
            }

            .game-layout {
                grid-template-columns: 1fr; /* Une seule colonne */
                grid-template-rows: auto auto 1fr; /* Header, Sidebar, Story */
                gap: 1rem;
                height: auto; /* Permet √† la hauteur de s'adapter au contenu */
            }

            .welcome-title {
                font-size: 2.5rem;
            }

            .mode-grid {
                grid-template-columns: 1fr; /* Une seule colonne pour les arch√©types */
            }

            .header {
                padding: 1rem;
            }

            .nav {
                flex-direction: column; /* √âl√©ments du header en colonne */
                gap: 1rem;
            }

            .quick-actions {
                grid-template-columns: 1fr; /* Actions rapides en colonne */
            }

            .sidebar {
                order: -1; /* Place la sidebar en haut sur mobile */
                max-height: 50vh; /* Limite la hauteur de la sidebar sur mobile */
                overflow-y: auto; /* Permet le d√©filement si n√©cessaire */
            }

            .story-content {
                min-height: 400px; /* Hauteur minimale pour l'histoire */
            }
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>
    <div class="stars"></div>

    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="logo">Echo Verse</div>
            <div class="user-info">
                <div class="save-status" id="saveStatus">üíæ Initialisation...</div>
                <span class="user-name" id="userDisplay">Invit√©</span>
            </div>
        </nav>
    </header>

    <div class="container">
        <!-- √âcran d'accueil -->
        <div id="homeScreen" class="screen active">
            <div class="home-section">
                <h1 class="welcome-title">Echo Verse</h1>
                <p class="welcome-subtitle">
                    Aventures infinies g√©n√©r√©es par l'Intelligence Artificielle
                </p>

                <div class="introduction-text">
                    <strong>Bienvenue, explorateur !</strong><br><br>
                    Dans Echo Verse, vous n'√™tes pas qu'un joueur, vous √™tes le h√©ros d'une histoire sans fin, cr√©√©e et fa√ßonn√©e par une intelligence artificielle. Vos choix guident le r√©cit, influencent votre destin√©e, et ouvrent des chemins inattendus. L'aventure n'attend que vous. Entrez votre nom, et pr√©parez-vous √† plonger dans l'inconnu.
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label" for="displayName">üé≠ Nom de joueur</label>
                        <input type="text" id="displayName" class="form-input" placeholder="Entrez votre nom de joueur" maxlength="20">
                    </div>
                    <button class="btn" onclick="login()">üöÄ Commencer l'Aventure</button>
                </div>
            </div>
        </div>

        <!-- √âcran de cr√©ation de personnage -->
        <div id="characterScreen" class="screen">
            <h2 class="welcome-title" style="text-align: center; margin-bottom: 2rem;">‚öîÔ∏è Cr√©ez Votre H√©ros</h2>

            <div class="card">
                <div class="form-group">
                    <label class="form-label" for="characterName">üë§ Nom du personnage</label>
                    <input type="text" id="characterName" class="form-input" placeholder="Ex: Aria Shadowblade" maxlength="25">
                </div>

                <div class="form-group">
                    <label class="form-label" for="characterArchetype">üéØ Arch√©type</label>
                    <select id="characterArchetype" class="form-input form-select">
                        <option value="">Choisissez un arch√©type</option>
                        <option value="guerrier">‚öîÔ∏è Guerrier - Expert du combat rapproch√©</option>
                        <option value="mage">üîÆ Mage - Ma√Ætre des arts magiques</option>
                        <option value="voleur">üó°Ô∏è Voleur - Sp√©cialiste de la discr√©tion</option>
                        <option value="ranger">üèπ R√¥deur - Gardien de la nature</option>
                        <option value="clerc">‚ú® Clerc - Gu√©risseur divin</option>
                        <option value="barde">üéµ Barde - Artiste aux mille talents</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="characterDescription">üëÅÔ∏è Description physique</label>
                    <textarea id="characterDescription" class="form-input form-textarea" placeholder="D√©crivez l'apparence de votre personnage..." maxlength="500"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="characterBackground">üìñ Histoire personnelle (contexte)</label>
                    <textarea id="characterBackground" class="form-input form-textarea" placeholder="Que sait-on de son pass√© ? D'o√π vient-il ?" maxlength="500"></textarea>
                </div>

                <button class="btn" onclick="createCharacter()">‚úîÔ∏è D√©marrer l'Aventure !</button>
            </div>
        </div>

        <!-- √âcran de jeu principal -->
        <div id="gameScreen" class="screen">
            <div class="game-layout">
                <!-- Panneau d'histoire et d'action -->
                <div class="story-panel">
                    <div id="storyContent" class="story-content">
                        <!-- L'histoire g√©n√©r√©e par l'IA sera ins√©r√©e ici -->
                        <div class="loading" id="storyLoading">
                            <div class="spinner"></div>
                            <p>G√©n√©ration de l'histoire...</p>
                        </div>
                    </div>

                    <div class="action-panel">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" for="actionInput">‚úçÔ∏è Votre prochaine action</label>
                            <textarea id="actionInput" class="action-input" placeholder="D√©crivez ce que vous voulez faire..."></textarea>
                        </div>
                        <button class="btn" onclick="performAction()">Agir</button>
                    </div>
                </div>

                <!-- Sidebar (statistiques et inventaire) -->
                <div class="sidebar">
                    <!-- Statistiques du personnage -->
                    <div class="stats-panel card">
                        <h3 class="panel-title">Statistiques de <span id="displayCharacterName"></span></h3>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span>‚ù§Ô∏è Sant√©</span>
                                <span id="displayHealthValue">100%</span>
                            </div>
                            <div class="stat-bar">
                                <div id="displayHealthBar" class="stat-fill health" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span>‚ö° √ânergie</span>
                                <span id="displayEnergyValue">100%</span>
                            </div>
                            <div class="stat-bar">
                                <div id="displayEnergyBar" class="stat-fill energy" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="gold-display">
                            <span>üí∞ Or:</span>
                            <span id="displayGoldValue">0</span>
                        </div>
                        <div class="game-state-item" style="margin-top: 1rem;">
                            <strong>üìç Lieu:</strong> <span id="displayCurrentLocation">Inconnu</span>
                        </div>
                        <div class="game-state-item" style="margin-top: 0.5rem;">
                            <strong>üí° Comp√©tences:</strong> <span id="displaySkills">Aucune</span>
                        </div>
                    </div>

                    <!-- Inventaire du personnage -->
                    <div class="inventory-panel card">
                        <h3 class="panel-title">üéí Inventaire</h3>
                        <div id="inventoryGrid" class="inventory-grid">
                            <!-- Les objets de l'inventaire seront ins√©r√©s ici dynamiquement -->
                            <div class="inventory-slot"><span>?</span></div>
                            <div class="inventory-slot"><span>?</span></div>
                            <div class="inventory-slot"><span>?</span></div>
                            <div class="inventory-slot"><span>?</span></div>
                            <div class="inventory-slot"><span>?</span></div>
                            <div class="inventory-slot"><span>?</span></div>
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="resetGame()">üîÅ Recommencer l'Aventure</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Importe les fonctions n√©cessaires de Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // D√©claration des variables globales pour Firebase et l'√©tat du jeu
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // ID utilisateur Firebase
        let appUserDisplayName = ''; // Nom de joueur affich√© dans le header
        let currentCharacterName = ''; // Nom du personnage actuel
        let isFirebaseReady = false; // Statut de l'initialisation Firebase

        // √âtat du jeu g√©r√© localement (sera synchronis√© avec Firebase)
        let gameState = {
            playerName: '', // Nom de joueur (le compte)
            characterName: '', // Nom du personnage
            archetype: '',
            description: '',
            background: '',
            currentLocation: 'Un endroit inconnu',
            inventory: [],
            health: 100,
            energy: 100,
            gold: 0,
            skills: [],
            storyHTML: '' // HTML de l'histoire pour persistance
        };

        // Variables Firebase globales disponibles via l'environnement Canvas
        // __app_id et __firebase_config sont des variables sp√©ciales fournies par l'environnement Canvas.
        // Si elles ne sont pas d√©finies (par exemple, si vous ex√©cutez le fichier HTML localement sans Canvas),
        // nous utilisons des valeurs par d√©faut.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const saveStatusElement = document.getElementById('saveStatus');

        // Fonction pour afficher une notification temporaire
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('hide'); // Ajoute une classe pour l'animation de disparition
                notification.addEventListener('animationend', () => notification.remove()); // Supprime apr√®s l'animation
            }, duration);
        }

        // Fonction pour afficher une modale d'alerte personnalis√©e
        function showAlert(title, message, type = 'error', onConfirmCallback = null) {
            const overlay = document.createElement('div');
            overlay.className = 'alert-overlay'; // Utilisez la classe pour l'overlay
            overlay.innerHTML = `
                <div class="alert-content ${type}">
                    <h3 class="alert-title">${title}</h3>
                    <p class="alert-message">${message}</p>
                    ${onConfirmCallback ?
                        `<button id="modalConfirmBtn" class="btn">Oui</button><button id="modalCancelBtn" class="btn btn-secondary" style="margin-left: 10px;">Non</button>` :
                        `<button id="modalCloseBtn" class="btn">OK</button>`
                    }
                </div>
            `;
            document.body.appendChild(overlay);

            if (onConfirmCallback) {
                document.getElementById('modalConfirmBtn').onclick = () => {
                    document.body.removeChild(overlay);
                    onConfirmCallback();
                };
                document.getElementById('modalCancelBtn').onclick = () => {
                    document.body.removeChild(overlay);
                };
            } else {
                document.getElementById('modalCloseBtn').onclick = () => {
                    document.body.removeChild(overlay);
                };
            }
        }

        // Fonction d'initialisation de Firebase
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Configuration Firebase non disponible. Le stockage des donn√©es ne fonctionnera pas.");
                    saveStatusElement.textContent = "‚ö†Ô∏è Sauvegarde d√©sactiv√©e (local)";
                    saveStatusElement.classList.add('warning');
                    isFirebaseReady = false;
                    return;
                }

                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                } catch (initError) {
                    console.error("Erreur lors de l'initialisation de l'application Firebase:", initError);
                    showAlert('Erreur critique', 'Impossible d\'initialiser l\'application Firebase. Le stockage des donn√©es sera d√©sactiv√©.', 'error');
                    saveStatusElement.textContent = "‚ùå Erreur Firebase";
                    saveStatusElement.classList.add('error');
                    isFirebaseReady = false;
                    return;
                }

                // G√©rer l'√©tat d'authentification
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userDisplay').textContent = appUserDisplayName || 'Joueur'; // Affiche le nom de joueur du compte
                        saveStatusElement.textContent = "‚úÖ Sauvegarde cloud active";
                        saveStatusElement.classList.remove('warning', 'error');
                        isFirebaseReady = true;
                        console.log("Utilisateur Firebase authentifi√©:", userId);

                        // Si on est d√©j√† sur l'√©cran de jeu et qu'on vient de s'authentifier
                        // (ex: si l'authentification a pris du temps apr√®s la saisie du nom)
                        if (document.getElementById('gameScreen').classList.contains('active') && currentCharacterName) {
                            loadGame(currentCharacterName);
                        }
                    } else {
                        userId = 'anonymous'; // Si non authentifi√©, utilise un ID temporaire
                        document.getElementById('userDisplay').textContent = 'Invit√©';
                        saveStatusElement.textContent = "‚ö†Ô∏è Sauvegarde locale active";
                        saveStatusElement.classList.add('warning');
                        isFirebaseReady = false;
                        console.log("Aucun utilisateur Firebase authentifi√© (√©tat actuel).");
                    }
                });

                // Tentative d'authentification initiale
                try {
                    if (initialAuthToken) {
                        console.log("Tentative de connexion avec jeton personnalis√©...");
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        console.log("Aucun jeton personnalis√© fourni, tentative de connexion anonyme...");
                        await signInAnonymously(auth);
                    }
                } catch (authError) {
                    console.error("Erreur lors de la tentative d'authentification initiale:", authError);
                    showAlert('Erreur d\'authentification', 'Impossible de se connecter. La sauvegarde ne fonctionnera pas.', 'warning');
                    saveStatusElement.textContent = "‚ö†Ô∏è Sauvegarde limit√©e";
                    saveStatusElement.classList.add('warning');
                    isFirebaseReady = false;
                }

                console.log("Firebase initialis√© et tentative d'authentification effectu√©e. isFirebaseReady:", isFirebaseReady);

            } catch (error) {
                console.error("Erreur critique lors de l'initialisation de Firebase (avant authentification):", error);
                showAlert('Erreur critique', 'Impossible d\'initialiser Firebase. Le stockage des donn√©es sera d√©sactiv√©.', 'error');
                saveStatusElement.textContent = "‚ùå Firebase non disponible";
                saveStatusElement.classList.add('error');
                isFirebaseReady = false;
            }
        }

        // Appelle l'initialisation de Firebase au chargement du script
        initializeFirebase();

        // Fonction pour changer d'√©cran
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // G√©rer la touche Entr√©e pour soumettre l'action
        document.getElementById('actionInput').addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) { // Permet d'ins√©rer des retours √† la ligne avec Shift+Enter
                event.preventDefault(); // Emp√™che le saut de ligne par d√©faut
                performAction();
            }
        });


        // Fonction pour l'√©cran d'accueil -> login (nom du joueur)
        async function login() {
            appUserDisplayName = document.getElementById('displayName').value.trim();
            if (!appUserDisplayName) {
                showAlert('Erreur', 'Veuillez entrer un nom de joueur.');
                return;
            }
            document.getElementById('userDisplay').textContent = appUserDisplayName;
            showScreen('characterScreen'); // Passe √† l'√©cran de cr√©ation de personnage
        }

        // Fonction pour l'√©cran de cr√©ation de personnage -> d√©marrer le jeu
        async function createCharacter() {
            const characterNameInput = document.getElementById('characterName').value.trim();
            const characterArchetype = document.getElementById('characterArchetype').value;
            const characterDescription = document.getElementById('characterDescription').value.trim();
            const characterBackground = document.getElementById('characterBackground').value.trim();

            if (!characterNameInput || !characterArchetype) {
                showAlert('Erreur', 'Veuillez au moins renseigner le nom et l\'arch√©type de votre personnage.');
                return;
            }

            currentCharacterName = characterNameInput; // D√©finir le nom du personnage actuel

            // Mettre √† jour l'√©tat du jeu global avec les infos du personnage
            gameState.playerName = appUserDisplayName;
            gameState.characterName = currentCharacterName;
            gameState.archetype = characterArchetype;
            gameState.description = characterDescription;
            gameState.background = characterBackground;
            gameState.currentLocation = 'Un lieu inconnu, au d√©but de votre aventure.';
            gameState.inventory = [];
            gameState.health = 100;
            gameState.energy = 100;
            gameState.gold = 0;
            gameState.skills = [];
            gameState.storyHTML = ''; // R√©initialiser l'histoire HTML

            document.getElementById('displayCharacterName').textContent = currentCharacterName;

            showScreen('gameScreen'); // Passe √† l'√©cran de jeu
            await initializeGameSession(); // Lance la session de jeu (charge ou nouvelle partie)
        }

        // Initialise la session de jeu (tente de charger ou d√©marre une nouvelle aventure)
        async function initializeGameSession() {
            if (isFirebaseReady && db && userId && currentCharacterName) {
                const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/characters`, currentCharacterName);
                try {
                    const docSnap = await getDoc(gameDocRef);
                    if (docSnap.exists()) {
                        console.log("Partie sauvegard√©e trouv√©e pour", currentCharacterName);
                        await loadGame(currentCharacterName);
                        showNotification('Partie charg√©e ! Reprenez votre aventure.', 'success');
                    } else {
                        console.log("Aucune partie sauvegard√©e trouv√©e pour", currentCharacterName, ". D√©marrage d'une nouvelle aventure.");
                        await startNewAdventure();
                        showNotification('Nouvelle aventure commenc√©e !', 'success');
                    }
                } catch (error) {
                    console.error("Erreur lors de la v√©rification de la sauvegarde:", error);
                    showAlert('Erreur de chargement', 'Impossible de v√©rifier la sauvegarde. D√©marrage d\'une nouvelle aventure.');
                    await startNewAdventure();
                }
            } else {
                console.warn("Firebase non pr√™t ou personnage non d√©fini. D√©marrage d'une nouvelle aventure sans sauvegarde.");
                showAlert('Avertissement', 'Le service de sauvegarde n\'est pas disponible. Votre progression ne sera pas sauvegard√©e.', 'warning');
                await startNewAdventure();
            }
        }

        // Charger l'√©tat du jeu depuis Firestore
        async function loadGame(charName) {
            if (!isFirebaseReady || !db || !userId || !charName) {
                console.log("Firebase non pr√™t ou charName non d√©fini pour charger le jeu.");
                return;
            }
            const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/characters`, charName);

            // Utilise onSnapshot pour une √©coute en temps r√©el des changements
            onSnapshot(gameDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const savedGameState = docSnap.data();
                    console.log("Donn√©es de sauvegarde re√ßues:", savedGameState);

                    // Restaurer l'√©tat du jeu global
                    gameState = { ...gameState, ...savedGameState }; // Fusionne l'√©tat sauvegard√© avec l'√©tat actuel
                    
                    document.getElementById('storyContent').innerHTML = gameState.storyHTML; // Restaurer l'HTML de l'histoire
                    updateGameStateDisplay(); // Mettre √† jour l'affichage
                    document.getElementById('storyContent').scrollTop = document.getElementById('storyContent').scrollHeight; // Scroll to bottom
                } else {
                    console.log("La partie n'existe plus ou a √©t√© supprim√©e pour", charName);
                    // Si le document est supprim√©, on pourrait revenir √† l'√©cran de cr√©ation ou d'accueil
                    // Pour l'instant, ne fait rien de sp√©cial si on √©tait d√©j√† en jeu.
                    // Le `initializeGameSession` initial g√®re le cas de non-existence.
                }
            }, (error) => {
                console.error("Erreur lors de l'√©coute de la partie:", error);
                showAlert('Erreur de synchronisation', 'Impossible de maintenir la synchronisation avec la sauvegarde.', 'error');
            });
        }

        // Sauvegarder l'√©tat du jeu dans Firestore
        async function saveGame() {
            if (!isFirebaseReady || !db || !userId || !currentCharacterName) {
                console.warn("Impossible de sauvegarder : Firebase non pr√™t ou personnage non d√©fini.");
                return;
            }
            try {
                // S'assurer que le storyHTML est √† jour avant de sauvegarder
                gameState.storyHTML = document.getElementById('storyContent').innerHTML;

                const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/characters`, currentCharacterName);
                await setDoc(gameDocRef, gameState); // Sauvegarde l'objet gameState complet
                console.log("Partie sauvegard√©e avec succ√®s pour:", currentCharacterName);
                showNotification('Partie sauvegard√©e !', 'success', 2000);
            } catch (error) {
                console.error("Erreur lors de la sauvegarde de la partie:", error);
                showAlert('Erreur de sauvegarde', 'Impossible de sauvegarder votre progression.');
            }
        }

        // D√©marrer une nouvelle aventure
        async function startNewAdventure() {
            document.getElementById('storyLoading').style.display = 'block';
            document.getElementById('storyContent').innerHTML = `<div class="loading" id="storyLoading"><div class="spinner"></div><p>G√©n√©ration de l'histoire...</p></div>`; // Affiche le spinner
            resetGameStateDisplay(); // R√©initialise l'affichage des stats

            try {
                const initialStoryResponse = await generateInitialStory();
                gameState.storyHTML = ''; // R√©initialise pour la nouvelle histoire
                displayStoryEntry(initialStoryResponse.story, null);
                updateGameState(initialStoryResponse.gameState);
                saveGame(); // Sauvegarde l'√©tat initial
            } catch (error) {
                showAlert('Erreur', 'Impossible de d√©marrer l\'aventure. Veuillez r√©essayer.');
                console.error('Erreur lors du d√©marrage:', error);
            } finally {
                document.getElementById('storyLoading').style.display = 'none';
            }
        }

        // R√©initialiser le jeu (bouton "Recommencer l'aventure")
        async function resetGame() {
            showAlert("Confirmation", "√ätes-vous s√ªr de vouloir recommencer ? Votre progression actuelle sera perdue.", 'warning', async () => {
                // Supprimer la sauvegarde Firestore pour ce personnage, si Firebase est actif
                if (isFirebaseReady && currentCharacterName) {
                    try {
                        const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/characters`, currentCharacterName);
                        await deleteDoc(gameDocRef);
                        console.log("Ancienne sauvegarde supprim√©e.");
                        showNotification('Ancienne sauvegarde supprim√©e.', 'success', 2000);
                    } catch (error) {
                        console.error("Erreur lors de la suppression de la sauvegarde:", error);
                        showAlert('Erreur de suppression', 'Impossible de supprimer l\'ancienne sauvegarde.');
                    }
                } else {
                    console.warn("Firebase non pr√™t. L'ancienne sauvegarde n'a pas pu √™tre supprim√©e.");
                }

                // R√©initialiser l'√©tat local et revenir √† l'√©cran d'accueil
                resetGameStateDisplay();
                gameState = { // R√©initialiser compl√®tement l'objet gameState
                    playerName: appUserDisplayName, // Garde le nom du joueur du compte
                    characterName: '',
                    archetype: '',
                    description: '',
                    background: '',
                    currentLocation: 'Un lieu inconnu, au d√©but de votre aventure.',
                    inventory: [],
                    health: 100,
                    energy: 100,
                    gold: 0,
                    skills: [],
                    storyHTML: ''
                };
                document.getElementById('characterName').value = '';
                document.getElementById('characterArchetype').value = '';
                document.getElementById('characterDescription').value = '';
                document.getElementById('characterBackground').value = '';
                document.getElementById('storyContent').innerHTML = ''; // Efface l'histoire
                document.getElementById('actionInput').value = ''; // Efface l'input

                currentCharacterName = ''; // R√©initialise le personnage actuel
                document.getElementById('displayCharacterName').textContent = '';

                showScreen('homeScreen'); // Retour √† l'√©cran d'accueil
                showAlert('Aventure r√©initialis√©e', 'Une nouvelle aventure vous attend !', 'success');
            });
        }


        // Fonction pour g√©n√©rer l'histoire initiale via l'API Gemini
        async function generateInitialStory() {
            const initialPrompt = `Tu es le ma√Ætre de jeu d'une aventure textuelle RPG immersive. Le joueur s'appelle ${gameState.playerName}, et son personnage est ${gameState.characterName}.
            Son arch√©type est "${gameState.archetype}".
            Sa description physique : "${gameState.description || 'non sp√©cifi√©e'}".
            Son histoire personnelle/contexte : "${gameState.background || 'non sp√©cifi√©e'}".

            Cr√©e une introduction fascinante pour son aventure, en int√©grant ces informations pour personnaliser le d√©but. Le ton doit √™tre √©pique, myst√©rieux ou aventureux, selon l'arch√©type et le contexte.
            Propose le lieu actuel, des √©l√©ments initiaux de son inventaire (2-3 objets pertinents pour l'arch√©type), sa sant√© (entre 80 et 100), son √©nergie (entre 80 et 100) et une petite quantit√© d'or (entre 10 et 50).
            Si l'arch√©type ou le contexte sont vides, utilise des valeurs par d√©faut pour un h√©ros g√©n√©rique.

            R√©ponds au format JSON avec les cl√©s suivantes : 'story' (texte de l'histoire), 'gameState' (objet avec 'currentLocation', 'inventory' (tableau de cha√Ænes), 'health' (nombre), 'energy' (nombre), 'gold' (nombre), 'skills' (tableau de cha√Ænes)).`
            ;
            return callGeminiAPI(initialPrompt);
        }

        // Effectuer une action et obtenir la suite de l'histoire
        async function performAction() {
            const action = document.getElementById('actionInput').value.trim();

            if (!action) {
                showAlert('Erreur', 'Veuillez d√©crire votre action.');
                return;
            }

            // Afficher le spinner de chargement dans la zone de l'histoire
            document.getElementById('storyLoading').style.display = 'block';
            document.getElementById('actionInput').value = ''; // Efface l'input

            try {
                // R√©cup√©rer le contenu de l'histoire actuelle pour le contexte
                const storyContentDiv = document.getElementById('storyContent');
                const storyEntries = Array.from(storyContentDiv.querySelectorAll('.story-entry p, .story-entry .action-text'))
                                          .map(element => element.textContent.trim())
                                          .join('\n\n');

                const prompt = `Le joueur ${gameState.playerName}, incarnant ${gameState.characterName} (${gameState.archetype}), est actuellement √† l'endroit suivant: "${gameState.currentLocation}".
                Son inventaire est: ${gameState.inventory.length > 0 ? gameState.inventory.join(', ') : 'vide'}.
                Sa sant√© est: ${gameState.health}%, son √©nergie est: ${gameState.energy}%, et il a: ${gameState.gold} pi√®ces d'or.
                Ses comp√©tences sont: ${gameState.skills.length > 0 ? gameState.skills.join(', ') : 'aucune'}.

                L'histoire actuelle est : "${storyEntries}".
                Le joueur d√©cide de : "${action}".

                En tant que ma√Ætre de jeu IA, continue l'histoire en tenant compte de cette action, des statistiques du personnage et du contexte. D√©cris les cons√©quences de l'action du joueur et fais avancer l'intrigue.
                Mets √† jour l'√©tat du jeu si n√©cessaire (currentLocation, inventory (ajouts/retraits), health (pertes/gains, max 100, min 0), energy (pertes/gains, max 100, min 0), gold (gains/pertes), skills (ajouts/retraits)). Si la sant√© ou l'√©nergie tombe √† 0, indique que le personnage est K.O. ou doit se reposer.

                R√©ponds au format JSON avec les cl√©s suivantes : 'story' (nouveau texte de l'histoire), 'gameState' (objet avec 'currentLocation', 'inventory' (tableau de cha√Ænes), 'health' (nombre), 'energy' (nombre), 'gold' (nombre), 'skills' (tableau de cha√Ænes)).`;

                const response = await callGeminiAPI(prompt);
                displayStoryEntry(response.story, action);
                updateGameState(response.gameState); // Met √† jour l'√©tat du jeu global et l'affichage
                saveGame(); // Sauvegarde l'√©tat apr√®s chaque action

            } catch (error) {
                showAlert('Erreur', 'Erreur lors du traitement de votre action. Veuillez r√©essayer.');
                console.error('Erreur lors de l\'action:', error);
            } finally {
                document.getElementById('storyLoading').style.display = 'none'; // Cache le spinner
            }
        }

        // Fonction g√©n√©rique pour appeler l'API Gemini
        async function callGeminiAPI(prompt) {
            const apiKey = ""; // Cl√© API inject√©e par l'environnement Canvas
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "story": { "type": "STRING" },
                            "gameState": {
                                "type": "OBJECT",
                                "properties": {
                                    "currentLocation": { "type": "STRING" },
                                    "inventory": { "type": "ARRAY", "items": { "type": "STRING" } },
                                    "health": { "type": "NUMBER" },
                                    "energy": { "type": "NUMBER" },
                                    "gold": { "type": "NUMBER" },
                                    "skills": { "type": "ARRAY", "items": { "type": "STRING" } }
                                },
                                "required": ["currentLocation", "inventory", "health", "energy", "gold", "skills"]
                            }
                        },
                        "required": ["story", "gameState"]
                    }
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erreur de l'API Gemini, statut:", response.status, "Corps:", errorBody);
                    throw new Error(`Erreur HTTP: ${response.status} - ${errorBody}`);
                }

                const result = await response.json();
                console.log("R√©ponse brute de l'API:", result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    // Tente de parser le texte comme JSON
                    const parsedJson = JSON.parse(text);
                    return parsedJson;
                } else {
                    console.error("Structure de r√©ponse inattendue de l'API Gemini:", result);
                    throw new Error("R√©ponse de l'IA mal form√©e ou vide.");
                }
            } catch (error) {
                console.error("Erreur lors de l'appel √† l'API Gemini:", error);
                throw error;
            }
        }

        // Afficher une entr√©e d'histoire dans le journal
        function displayStoryEntry(storyText, actionTaken) {
            const storyContentDiv = document.getElementById('storyContent');
            const newEntry = document.createElement('div');
            newEntry.className = 'story-entry';

            if (actionTaken) {
                const actionPara = document.createElement('p');
                actionPara.className = 'action-text';
                actionPara.textContent = `> ${actionTaken}`;
                newEntry.appendChild(actionPara);
            }

            const storyPara = document.createElement('p');
            storyPara.className = 'story-text';
            storyPara.innerHTML = storyText.replace(/\n/g, '<br>'); // Remplace les retours √† la ligne par des <br>
            newEntry.appendChild(storyPara);

            storyContentDiv.appendChild(newEntry);
            // Faire d√©filer vers le bas pour voir la derni√®re entr√©e
            storyContentDiv.scrollTop = storyContentDiv.scrollHeight;
        }

        // Met √† jour l'√©tat du jeu global et rafra√Æchit l'affichage
        function updateGameState(newGameState) {
            if (!newGameState) return;

            // Assurer que les valeurs sont dans les limites [0, 100] pour sant√© et √©nergie
            newGameState.health = Math.max(0, Math.min(100, newGameState.health));
            newGameState.energy = Math.max(0, Math.min(100, newGameState.energy));
            newGameState.gold = Math.max(0, newGameState.gold); // L'or ne peut pas √™tre n√©gatif

            // Fusionne le nouvel √©tat avec l'√©tat actuel du jeu
            Object.assign(gameState, newGameState);

            updateGameStateDisplay();
        }

        // Met √† jour l'affichage de l'√©tat du jeu √† partir de l'objet gameState global
        function updateGameStateDisplay() {
            document.getElementById('displayCharacterName').textContent = gameState.characterName;
            document.getElementById('displayCurrentLocation').textContent = gameState.currentLocation || 'Inconnu';

            // Sant√©
            document.getElementById('displayHealthValue').textContent = `${gameState.health}%`;
            document.getElementById('displayHealthBar').style.width = `${gameState.health}%`;
            if (gameState.health <= 20) {
                 document.getElementById('displayHealthBar').style.background = 'linear-gradient(90deg, #ff0000, #ff8888)';
            } else if (gameState.health <= 50) {
                 document.getElementById('displayHealthBar').style.background = 'linear-gradient(90deg, #ffaa00, #ffcc88)';
            } else {
                 document.getElementById('displayHealthBar').style.background = 'linear-gradient(90deg, var(--health-color), #ff8888)';
            }


            // √ânergie
            document.getElementById('displayEnergyValue').textContent = `${gameState.energy}%`;
            document.getElementById('displayEnergyBar').style.width = `${gameState.energy}%`;
            if (gameState.energy <= 20) {
                document.getElementById('displayEnergyBar').style.background = 'linear-gradient(90deg, #ff00ff, #ff88ff)'; // Couleur faible √©nergie
            } else if (gameState.energy <= 50) {
                document.getElementById('displayEnergyBar').style.background = 'linear-gradient(90deg, #ffdd00, #ffee55)'; // Couleur moyenne √©nergie
            } else {
                document.getElementById('displayEnergyBar').style.background = 'linear-gradient(90deg, var(--energy-color), #88aaff)';
            }


            // Or
            document.getElementById('displayGoldValue').textContent = gameState.gold;

            // Inventaire
            const inventoryGrid = document.getElementById('inventoryGrid');
            inventoryGrid.innerHTML = ''; // Nettoie l'inventaire actuel

            // Ajoute les objets de l'inventaire
            gameState.inventory.forEach(item => {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot filled';
                slot.innerHTML = `<span>${item}</span>`;
                inventoryGrid.appendChild(slot);
            });

            // Remplit les slots vides si l'inventaire n'est pas plein (max 6 slots pour l'exemple)
            const maxSlots = 6;
            for (let i = gameState.inventory.length; i < maxSlots; i++) {
                const emptySlot = document.createElement('div');
                emptySlot.className = 'inventory-slot';
                emptySlot.innerHTML = '<span>Vide</span>';
                inventoryGrid.appendChild(emptySlot);
            }

            // Comp√©tences
            document.getElementById('displaySkills').textContent = gameState.skills && gameState.skills.length > 0 ? gameState.skills.join(', ') : 'Aucune';
        }

        // R√©initialiser l'affichage de l'√©tat du jeu (pour un nouveau personnage/d√©but)
        function resetGameStateDisplay() {
            document.getElementById('displayCharacterName').textContent = '';
            document.getElementById('displayCurrentLocation').textContent = 'Inconnu';

            document.getElementById('displayHealthValue').textContent = '100%';
            document.getElementById('displayHealthBar').style.width = '100%';
            document.getElementById('displayHealthBar').style.background = 'linear-gradient(90deg, var(--health-color), #ff8888)'; // R√©initialise la couleur

            document.getElementById('displayEnergyValue').textContent = '100%';
            document.getElementById('displayEnergyBar').style.width = '100%';
            document.getElementById('displayEnergyBar').style.background = 'linear-gradient(90deg, var(--energy-color), #88aaff)'; // R√©initialise la couleur

            document.getElementById('displayGoldValue').textContent = '0';

            const inventoryGrid = document.getElementById('inventoryGrid');
            inventoryGrid.innerHTML = '';
            const maxSlots = 6;
            for (let i = 0; i < maxSlots; i++) {
                const emptySlot = document.createElement('div');
                emptySlot.className = 'inventory-slot';
                emptySlot.innerHTML = '<span>Vide</span>';
                inventoryGrid.appendChild(emptySlot);
            }

            document.getElementById('displaySkills').textContent = 'Aucune';
        }

        // Assurez-vous que l'initialisation de Firebase est appel√©e au chargement
        // Cela est d√©j√† fait au d√©but du script : initializeFirebase();
    </script>
</body>
</html>
